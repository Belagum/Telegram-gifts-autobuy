# GiftBuyer

–í–µ–±-–ø–∞–Ω–µ–ª—å –∏ –±–æ—Ç –¥–ª—è **–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –∞–≤—Ç–æ–ø–æ–∫—É–ø–∫–∏ Telegram-–ø–æ–¥–∞—Ä–∫–æ–≤** –Ω–∞ –±–∞–∑–µ **Flask + SQLAlchemy + Pyrogram** (backend) –∏ **React + Vite** (frontend).
–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —Ä–∞–±–æ—Ç–∞ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏, –ø—Ä–æ—Å–º–æ—Ç—Ä –±–∞–ª–∞–Ω—Å–∞ –∑–≤—ë–∑–¥, —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–æ–¥–∞—Ä–∫–æ–≤ —Å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–º **.tgs (Lottie)**, —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∫–∞–Ω–∞–ª–æ–≤ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ (–ø–æ —Ü–µ–Ω–µ –∏ supply), –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ –∫–∞–Ω–∞–ª—ã/–õ–° –∏ **–∞–≤—Ç–æ–ø–æ–∫—É–ø–∫–∞ –ª–∏–º–∏—Ç–Ω—ã—Ö –ø–æ–¥–∞—Ä–∫–æ–≤ –Ω–∞ –Ω—É–∂–Ω—ã–µ –∫–∞–Ω–∞–ª—ã**.

---

## –ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

*  –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è/–ª–æ–≥–∏–Ω (httpOnly cookie, 7 –¥–Ω–µ–π).
*  –ù–µ—Å–∫–æ–ª—å–∫–æ **API-–ø—Ä–æ—Ñ–∏–ª–µ–π** (api\_id/api\_hash) –∏ **–Ω–µ—Å–∫–æ–ª—å–∫–æ Telegram-–∞–∫–∫–∞—É–Ω—Ç–æ–≤** –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
*  –ü—Ä–æ—Å–º–æ—Ç—Ä Premium, **–±–∞–ª–∞–Ω—Å –∑–≤—ë–∑–¥**, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤ —Å–æ —Å—Ç—Ä–∏–º–æ–º —Å—Ç–∞–¥–∏–π (NDJSON).
*  **–ü–æ–¥–∞—Ä–∫–∏ (Gifts)**: —Å–ø–∏—Å–æ–∫, —Ä—É—á–Ω–æ–µ/—Ñ–æ–Ω–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, SSE-—Å—Ç—Ä–∏–º, –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä .tgs (—Å–µ—Ä–≤–µ—Ä–Ω—ã–π –∫—ç—à).
*  **–ö–∞–Ω–∞–ª—ã**: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ `channel_id` (—Ñ–æ—Ä–º–∞—Ç `-100‚Ä¶`), –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–ª–µ–Ω—Å—Ç–≤–∞, —Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ **—Ü–µ–Ω–∞/supply**, CRUD.
*  **–ê–≤—Ç–æ–ø–æ–∫—É–ø–∫–∞** –ª–∏–º–∏—Ç–Ω—ã—Ö –ø–æ–¥–∞—Ä–∫–æ–≤ –Ω–∞ –∫–∞–Ω–∞–ª—ã –ø–æ –∑–∞–¥–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º, —Å –æ—Ç—á—ë—Ç–∞–º–∏ –≤ –õ–° –∏ –ø–æ–¥—Ä–æ–±–Ω—ã–º–∏ –ø—Ä–∏—á–∏–Ω–∞–º–∏, –µ—Å–ª–∏ –Ω–µ –∫—É–ø–∏–ª–æ—Å—å.
*  **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** –æ –Ω–æ–≤—ã—Ö –ø–æ–¥–∞—Ä–∫–∞—Ö –≤ —É–∫–∞–∑–∞–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª—ã/–õ–° (—Å–æ —Å—Ç–∏–∫–µ—Ä–æ–º –∏ –∫—Ä–∞—Ç–∫–∏–º —Ç–µ–∫—Å—Ç–æ–º).
*  –ë—ç–∫–≥—Ä–∞—É–Ω–¥-–≤–æ—Ä–∫–µ—Ä –ø–æ–¥–∞—Ä–∫–æ–≤, —É—Å—Ç–æ–π—á–∏–≤—ã–π –∫ –ø–∞–¥–µ–Ω–∏—è–º –∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è–º, —Å ¬´–≥–æ—Ä—è—á–∏–º¬ª –ø–µ—Ä–µ—á–∏—Ç—ã–≤–∞–Ω–∏–µ–º –∞–∫–∫–∞—É–Ω—Ç–æ–≤.
---

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–ø–æ–∫—É–ø–∫–∞ (–∫—Ä–∞—Ç–∫–æ –ø—Ä–æ –∞–ª–≥–æ—Ä–∏—Ç–º)

–§–∞–π–ª: `backend/services/autobuy_service.py`

1. **–°–±–æ—Ä –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö**

   * –ë–µ—Ä—ë–º **–≤—Å–µ –∞–∫–∫–∞—É–Ω—Ç—ã** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —É–∑–Ω–∞—ë–º –∏—Ö **–±–∞–ª–∞–Ω—Å –∑–≤—ë–∑–¥**.
   * –ë–µ—Ä—ë–º **–≤—Å–µ –∫–∞–Ω–∞–ª—ã** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∏—Ö —Ñ–∏–ª—å—Ç—Ä—ã:

     * –¥–∏–∞–ø–∞–∑–æ–Ω `price_min..price_max`;
     * –¥–∏–∞–ø–∞–∑–æ–Ω `supply_min..supply_max` (–µ—Å–ª–∏ `null` ‚Äî –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è).
   * –ë–µ—Ä—ë–º **–Ω–æ–≤—ã–µ –ø–æ–¥–∞—Ä–∫–∏**, –ø—Ä–∏—à–µ–¥—à–∏–µ –æ—Ç –≤–æ—Ä–∫–µ—Ä–∞.
     ‚ö† –í –±–æ–µ–≤–æ–º —Ä–µ–∂–∏–º–µ –ø–æ–∫—É–ø–∞–µ–º **—Ç–æ–ª—å–∫–æ –ª–∏–º–∏—Ç–Ω—ã–µ** (`is_limited=True`). –ù–µ–ª–∏–º–∏—Ç–Ω—ã–µ —Å—Ä–∞–∑—É —Å–∫–∏–ø–∞–µ–º —Å –ø—Ä–∏—á–∏–Ω–æ–π.

2. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ–∑–∞—Ü–∏—è –ø–æ–¥–∞—Ä–∫–æ–≤**

   * –û—Ç—Å–µ–∫–∞–µ–º –º—É—Å–æ—Ä (–Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ `id/price/supply`).
   * –°–æ—Ä—Ç–∏—Ä—É–µ–º –ª–∏–º–∏—Ç–∫–∏ –ø–æ –∫–ª—é—á—É: **–º–µ–Ω—å—à–µ supply ‚Üí –¥–æ—Ä–æ–∂–µ ‚Üí —Å–ª—É—á–∞–π–Ω–æ—Å—Ç—å(–µ—Å–ª–∏ –æ–¥–∏–Ω–∞–∫–æ–≤–∞—è —Ü–µ–Ω–∞ –∏ supply)**.

3. **–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (¬´–ø–ª–∞–Ω –ø–æ–∫—É–ø–æ–∫¬ª)**
   –î–ª—è **–∫–∞–∂–¥–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞** (–≤ –ø–æ—Ä—è–¥–∫–µ —É–±—ã–≤–∞–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞) —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–∫—É–ø–∫–∏:

   * –î–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–¥–∞—Ä–∫–∞ –∏—â–µ—Ç—Å—è **–ø–æ–¥—Ö–æ–¥—è—â–∏–π –∫–∞–Ω–∞–ª** (–ø–æ —Ñ–∏–ª—å—Ç—Ä–∞–º —Ü–µ–Ω—ã/supply).
   * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –≤–æ–∑–º–æ–∂–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–ø—Ä–∞–≤–æ–∫ —Å —É—á—ë—Ç–æ–º **–æ—Å—Ç–∞—Ç–∫–∞ –±–∞–ª–∞–Ω—Å–∞** –∞–∫–∫–∞—É–Ω—Ç–∞ –∏ **–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏** –ø–æ–¥–∞—Ä–∫–∞.
   * –í –ø–ª–∞–Ω –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –æ–ø–µ—Ä–∞—Ü–∏–∏: `(account_id, channel_id, gift_id, price, supply)`.
   * –ï—Å–ª–∏ –Ω–∞ —ç—Ç–∞–ø–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —á—Ç–æ-—Ç–æ –Ω–µ —Å–æ—à–ª–æ—Å—å (–Ω–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –∫–∞–Ω–∞–ª–æ–≤, –Ω–µ —Ö–≤–∞—Ç–∏–ª–æ –∑–≤—ë–∑–¥ –∏ —Ç.–ø.), —ç—Ç–æ —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –≤ `plan_skips`.

4. **–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–∞**

   * –ò–¥—ë–º –ø–æ –ø–ª–∞–Ω—É –∏ –Ω–∞ –∫–∞–∂–¥–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–∑—ã–≤–∞–µ–º:

     ```
     await tg_client.send_gift(chat_id=<ID –∫–∞–Ω–∞–ª–∞>, gift_id=<ID –ø–æ–¥–∞—Ä–∫–∞>)
     ```
   * –£—Å–ø–µ—Ö/–Ω–µ—É—Å–ø–µ—Ö –¥–µ—Ç–∞–ª—å–Ω–æ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ **–ø–æ –∫–∞–Ω–∞–ª–∞–º** –∏ **–ø–æ –∞–∫–∫–∞—É–Ω—Ç–∞–º**.

5. **–û—Ç—á—ë—Ç—ã**

   * –§–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –æ—Ç—á—ë—Ç: –æ–±—â–∞—è —Å–≤–æ–¥–∫–∞, –ø–æ –ø–æ–¥–∞—Ä–∫–∞–º, –ø–æ –∫–∞–Ω–∞–ª–∞–º –∏ –ø–æ –∞–∫–∫–∞—É–Ω—Ç–∞–º.
   * –û—Ç—á—ë—Ç —É—Ö–æ–¥–∏—Ç –≤ **–ª—Å –≤—Å–µ—Ö –≤–∞—à–∏—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤** (—á–µ—Ä–µ–∑ –≤–∞—à Bot Token –∏–∑ ¬´–ù–∞—Å—Ç—Ä–æ–µ–∫¬ª).

6. **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ** –≤–æ—Ä–∫–µ—Ä —à–ª—ë—Ç **—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** –æ –Ω–æ–≤—ã—Ö –ø–æ–¥–∞—Ä–∫–∞—Ö –≤ –∫–∞–Ω–∞–ª—ã/–õ–°.
   –í `gifts_service` –ø–æ–∫—É–ø–∫–∞ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ (`asyncio.gather`), –ø–æ–∫—É–ø–∫–∞ **–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç** —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.


## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

* **Python** 3.13+
* **Node** 18+ / npm 9+
* –†–∞–±–æ—á–∏–π **api\_id/api\_hash** (my.telegram.org ‚Üí API development tools)
* –í–∞—à **Bot Token** (BotFather), —á—Ç–æ–±—ã —Å–ª–∞—Ç—å .tgs-–ø—Ä–µ–≤—å—é –∏ –æ—Ç—á—ë—Ç—ã –≤ –õ–°
* –ß–∞—Ç—ã, –∫—É–¥–∞ –±–æ—Ç –∏–º–µ–µ—Ç –ø—Ä–∞–≤–æ –ø–∏—Å–∞—Ç—å (–µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –∫–∞–Ω–∞–ª—ã)

---

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫ (–ª–æ–∫–∞–ª—å–Ω–æ)

### Backend

```bash
cd backend
python -m venv .venv
# Windows:
.\.venv\Scripts\activate
# macOS/Linux:
# source .venv/bin/activate

pip install -r requirements.txt

# (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –º–∏–≥—Ä–∞—Ü–∏—è/–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î,
# –µ—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –ø–µ—Ä–µ–Ω–æ—Å —Å—Ö–µ–º—ã:
python -m backend.migrate_app_db

# –ª–∏–±–æ —á–µ—Ä–µ–∑ –Ω–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç (—Å–æ–∑–¥–∞—ë—Ç —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é):
python -m backend.scripts.migrate_data app.db --migration 0001_initial.sql

# –∑–∞–ø—É—Å–∫ dev-—Å–µ—Ä–≤–µ—Ä–∞ (Flask)
python -m backend.app     # http://localhost:5000
```

**–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):**

* `SECRET_KEY` ‚Äî —Å–µ–∫—Ä–µ—Ç Flask.
* `DATABASE_URL` ‚Äî —Å—Ç—Ä–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è SQLAlchemy (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `sqlite:///app.db`).
* `DATABASE_POOL_SIZE` / `DATABASE_MAX_OVERFLOW` / `DATABASE_POOL_TIMEOUT` ‚Äî –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—É–ª–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π.
* `GIFTS_DIR` ‚Äî –∫–∞—Ç–∞–ª–æ–≥ —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–¥–∞—Ä–∫–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `gifts_data`).
* `GIFTS_CACHE_DIR` ‚Äî –∫—ç—à .tgs (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `backend/instance/gifts_cache`).
* `GIFTS_ACCS_TTL` ‚Äî –ø–µ—Ä–∏–æ–¥ (—Å–µ–∫) –ø–µ—Ä–µ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –≤–æ—Ä–∫–µ—Ä–æ–º (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `60`).
* `METRICS_ENABLED` ‚Äî –≤–∫–ª—é—á–∏—Ç—å —ç–∫—Å–ø–æ—Ä—Ç Prometheus-–º–µ—Ç—Ä–∏–∫ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `True`).
* `RESILIENCE_TIMEOUT`, `RESILIENCE_RETRIES`, `RESILIENCE_BACKOFF_BASE`, `RESILIENCE_BACKOFF_CAP` ‚Äî —Ç–∞–π–º–∞—É—Ç—ã –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–≤—Ç–æ—Ä–æ–≤.

### Frontend

```bash
cd frontend
npm i
npm run dev     # http://localhost:5173
```

–ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–æ–∫—Å–∏ `/api` ‚Üí `http://localhost:5000` –≤–æ `vite.config.js`.

### –ó–¥–æ—Ä–æ–≤—å–µ –∏ –Ω–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å

* `/healthz` ‚Äî –±–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∂–∏–≤–æ—Å—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞.
* `/readyz` ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î.
* `/metrics` ‚Äî Prometheus-–º–µ—Ç—Ä–∏–∫–∏ (`giftbuyer_request_latency_seconds`, `giftbuyer_requests_total`, `giftbuyer_workers`).

### –ú–∏–≥—Ä–∞—Ü–∏–∏ –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–µ—Ä–µ–Ω–æ—Å –¥–∞–Ω–Ω—ã—Ö

* –ü–µ—Ä–≤–∏—á–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ö–µ–º—ã –≤—ã–ø–æ–ª–Ω—è–µ—Ç `python -m backend.migrate_app_db` –∏–ª–∏ `python -m backend.scripts.migrate_data app.db --migration 0001_initial.sql`.
* `backend/scripts/migrate_data.py` –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º SQL-—Ñ–∞–π–ª–∞ —Å–æ–∑–¥–∞—ë—Ç —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é `<–∏–º—è>.bak` —Ä—è–¥–æ–º —Å –ë–î.
* –î–ª—è –æ—Ç–∫–∞—Ç–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –∑–∞–º–µ–Ω–∏—Ç—å —Ä–∞–±–æ—á–∏–π —Ñ–∞–π–ª –ë–î –Ω–∞ `.bak` –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ø–æ—Å–ª–µ —Ñ–∏–∫—Å–∞ –æ—à–∏–±–∫–∏.
* –ú–∏–≥—Ä–∞—Ü–∏–∏ –∞—Ç–æ–º–∞—Ä–Ω—ã (`BEGIN/COMMIT`), –∏–Ω–¥–µ–∫—Å—ã (`idx_channels_user_id`, `idx_channels_channel_id`) —É—Å–∫–æ—Ä—è—é—Ç –≤—ã–±–æ—Ä–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤.

### –ú–µ—Ç—Ä–∏–∫–∏, —Ç—Ä–µ–π—Å–∏–Ω–≥ –∏ –ø—Ä–∏–º–µ—Ä—ã –¥–∞—à–±–æ—Ä–¥–æ–≤

* –ú–µ—Ç—Ä–∏–∫–∏ Prometheus –≤–∫–ª—é—á–∞—é—Ç—Å—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `METRICS_ENABLED`. –ë–∞–∑–æ–≤—ã–π –Ω–∞–±–æ—Ä:
  * `giftbuyer_request_latency_seconds` (Histogram) ‚Äî –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å HTTP. –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞: `histogram_quantile(0.95, sum(rate(giftbuyer_request_latency_seconds_bucket[5m])) by (le))`.
  * `giftbuyer_requests_total{endpoint="api.gifts"}` ‚Äî —á–∞—Å—Ç–æ—Ç–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ –∫–æ–Ω–µ—á–Ω—ã–º —Ç–æ—á–∫–∞–º.
  * `giftbuyer_workers` ‚Äî —Ç–µ–∫—É—â–µ–µ —á–∏—Å–ª–æ —Ñ–æ–Ω–æ–≤—ã—Ö –≤–æ—Ä–∫–µ—Ä–æ–≤.
* –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π Grafana-–¥—ç—à–±–æ—Ä–¥:
  * –ü–∞–Ω–µ–ª—å ¬´P95 HTTP latency¬ª —Å —Ñ–æ—Ä–º—É–ª–æ–π –≤—ã—à–µ –∏ –µ–¥–∏–Ω–∏—Ü–∞–º–∏ ¬´milliseconds¬ª.
  * –ü–∞–Ω–µ–ª—å ¬´Request rate by endpoint¬ª c `sum(rate(giftbuyer_requests_total[1m])) by (endpoint)`.
  * –ü–∞–Ω–µ–ª—å ¬´Active workers¬ª c `giftbuyer_workers` (stat / gauge).
* –¢—Ä–µ–π—Å–∏–Ω–≥ –º–æ–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å —á–µ—Ä–µ–∑ OpenTelemetry, —É—Å—Ç–∞–Ω–æ–≤–∏–≤ `TRACING_ENABLED=1` –∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–≤ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π OTLP —ç–∫—Å–ø–æ—Ä—Ç—ë—Ä (—Ç–æ—á–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è ‚Äî `backend/infrastructure/observability.py`).

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ —Å–µ–∫—Ä–µ—Ç—ã

* –í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —á–∏—Ç–∞—é—Ç—Å—è –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è Pydantic-–º–æ–¥–µ–ª—å—é (`backend/config.py`).
* –°–µ–∫—Ä–µ—Ç—ã (—Ç–æ–∫–µ–Ω—ã, –∫–ª—é—á–∏) —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —á–µ—Ä–µ–∑ —Å–µ–∫—Ä–µ—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä (Docker Secrets, Vault) –∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞.
* –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `GIFTS_DIR` –∏ `GIFTS_CACHE_DIR` —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

### –¢–æ—á–∫–∏ –æ—Ç–∫–∞–∑–∞ –∏ —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å

* –í–Ω–µ—à–Ω–∏–µ –∑–∞–ø—Ä–æ—Å—ã Telegram –æ–±—ë—Ä–Ω—É—Ç—ã –≤ `resilient_call` —Å —Ç–∞–π–º–∞—É—Ç–æ–º, —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º –±—ç–∫–æ—Ñ—Ñ–æ–º –∏ circuit breaker (—Å–º. `backend/infrastructure/resilience.py`). –ü—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –ø–æ—Ä–æ–≥–∞ –æ—Ç–∫–∞–∑–æ–≤ –∑–∞–ø—Ä–æ—Å—ã –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è `RESILIENCE_CIRCUIT_RESET`.
* –û—á–µ—Ä–µ–¥—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `ResilientQueue` —Å visibility timeout, –ø–æ–∑–≤–æ–ª—è—é—â–∏–º –ø–æ–≤—Ç–æ—Ä–Ω–æ —Å—Ç–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏ —Å–±–æ—è—Ö –≤–æ—Ä–∫–µ—Ä–∞ (`backend/infrastructure/queue.py`).
* –î–æ—Å—Ç—É–ø –∫ –ë–î —á–µ—Ä–µ–∑ UoW (`backend/infrastructure/unit_of_work.py`) –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç rollback –ø—Ä–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏—è—Ö.
* Health/ready-–ø—Ä–æ–±—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ª–∞–≤–ª–∏–≤–∞—é—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ë–î –∏ –ø–æ–∑–≤–æ–ª—è—é—Ç –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä—É –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä.

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –Ω–∞–≥—Ä—É–∑–æ—á–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

* –°–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç –∞–≤—Ç–æ–ø–æ–∫—É–ø–∫–∏ (100 –∞–∫–∫–∞—É–Ω—Ç–æ–≤, 200 –ø–æ–¥–∞—Ä–∫–æ–≤) –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º: `python -m backend.tests.synth_bench_autobuy` (—Å–º. –ø—Ä–∏–º–µ—Ä—ã –≤ —Ä–∞–∑–¥–µ–ª–µ —Ç–µ—Å—Ç–æ–≤).
* –ù–∞ —ç—Ç–∞–ª–æ–Ω–Ω–æ–π –º–∞—à–∏–Ω–µ (2 vCPU, 4 –ì–ë RAM) –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è + –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç—á—ë—Ç–∞ –∑–∞–Ω—è–ª ~0.84 —Å, –ø—Ä–∏ —ç—Ç–æ–º —Å—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ—Å—Ç–∞–≤–∏–ª–∞ ~238 –æ–ø–µ—Ä–∞—Ü–∏–π/—Å (—Å–º. —Ä–∞–∑–¥–µ–ª ¬´Testing¬ª –Ω–∏–∂–µ).


## –ê–≤—Ç–æ–ø–æ–∫—É–ø–∫–∞ ‚Äî –ø—Ä–∞–≤–∏–ª–∞ –∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã

* –ü–æ–∫—É–ø–∞–µ–º **—Ç–æ–ª—å–∫–æ –ª–∏–º–∏—Ç–Ω—ã–µ** –ø–æ–¥–∞—Ä–∫–∏ (`is_limited=True`). –ù–µ–ª–∏–º–∏—Ç–Ω—ã–µ —Ñ–∏–∫—Å–∏—Ä—É—é—Ç—Å—è –∫–∞–∫ ¬´–ø—Ä–æ–ø—É—â–µ–Ω—ã¬ª —Å –ø—Ä–∏—á–∏–Ω–æ–π.
* –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–¥–∞—Ä–∫–∞ –ø–æ–¥–±–∏—Ä–∞–µ—Ç—Å—è **–ª—É—á—à–∏–π –∫–∞–Ω–∞–ª** —Å—Ä–µ–¥–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –ø–æ —Ñ–∏–ª—å—Ç—Ä–∞–º `price` –∏ `supply`:

  * –ï—Å–ª–∏ `supply_min/max` —É –∫–∞–Ω–∞–ª–∞ `null` ‚Äî –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è.
  * –ß–µ–º **—É–∂–µ** ¬´–æ–∫–Ω–æ¬ª –ø–æ supply –∏ —á–µ–º **–≤—ã—à–µ** `price_max`, —Ç–µ–º **–≤—ã—à–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç** –∫–∞–Ω–∞–ª–∞.
* –ü–ª–∞–Ω —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è **–ø–æ –≤—Å–µ–º –∞–∫–∫–∞—É–Ω—Ç–∞–º** (—Å–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –ø–æ —É–±—ã–≤–∞–Ω–∏—é –±–∞–ª–∞–Ω—Å–∞):

  * –ù–∞ –∫–∞–∂–¥—ã–π –∞–∫–∫–∞—É–Ω—Ç —Å—Ç–∞–≤–∏—Ç—Å—è —Å—Ç–æ–ª—å–∫–æ –ø–æ–∫—É–ø–æ–∫, —Å–∫–æ–ª—å–∫–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç **–±–∞–ª–∞–Ω—Å** –∏ **–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å** –ø–æ–¥–∞—Ä–∫–∞.
* –û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∏–º–µ–Ω–Ω–æ **–≤ –∫–∞–Ω–∞–ª**: `send_gift(chat_id=<ID –∫–∞–Ω–∞–ª–∞>, gift_id=...)`.
* –ü–æ–¥—Ä–æ–±–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã, –ø–æ—á–µ–º—É –Ω–µ –∫—É–ø–∏–ª–∏:

  * `no_channel_match` ‚Äî –Ω–µ –Ω–∞—à–ª–æ—Å—å –∫–∞–Ω–∞–ª–æ–≤, –≥–¥–µ –∏ `price`, –∏ `supply` —É–∫–ª–∞–¥—ã–≤–∞—é—Ç—Å—è –≤ —Ñ–∏–ª—å—Ç—Ä—ã.
  * `not_enough_stars` / `insufficient_account_balance` ‚Äî –Ω–µ —Ö–≤–∞—Ç–∏–ª–æ –∑–≤—ë–∑–¥.
  * `send_gift_failed` ‚Äî —Å–∞–º –≤—ã–∑–æ–≤ `send_gift` –ø—Ä–æ–≤–∞–ª–∏–ª—Å—è (–Ω–µ—Ç –ø—Ä–∞–≤ –ø–∏—Å–∞—Ç—å –≤ –∫–∞–Ω–∞–ª, –Ω–µ —á–ª–µ–Ω –∫–∞–Ω–∞–ª–∞, gift –±–æ–ª—å—à–µ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, —Ç—Ä–µ–±—É—é—Ç—Å—è Premium, –∏ —Ç.–ø.).
  * `invalid/price/supply` ‚Äî –ø–æ–¥–∞—Ä–æ–∫ –Ω–µ –ø—Ä–æ—à—ë–ª –±–∞–∑–æ–≤—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é.
* –í –õ–° —É—Ö–æ–¥–∏—Ç **–æ—Ç—á—ë—Ç** —Å —ç–º–æ–¥–∑–∏: —Å–≤–æ–¥–∫–∞, –ø–æ –ø–æ–¥–∞—Ä–∫–∞–º (—á—Ç–æ –∏ –∫—É–¥–∞ –∫—É–ø–∏–ª–∏, –ª–∏–±–æ –ø–æ—á–µ–º—É –ø—Ä–æ–ø—É—â–µ–Ω–æ), –ø–æ –∫–∞–Ω–∞–ª–∞–º –∏ –ø–æ –∞–∫–∫–∞—É–Ω—Ç–∞–º.


## –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –≤–∞–∂–Ω—ã–µ –ø–æ–ª—è

* **User.gifts\_autorefresh** ‚Äî –≤–∫–ª/–≤—ã–∫–ª –∞–≤—Ç–æ–ø–æ–∫—É–ø–∫—É.
* **UserSettings.bot\_token** ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ .tgs-—Å—Ç–∏–∫–µ—Ä–æ–≤ –∏ —Ç–µ–∫—Å—Ç–æ–≤ –≤ –∫–∞–Ω–∞–ª—ã/–õ–° (—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ –æ—Ç—á—ë—Ç—ã).
* **Channel**:

  * `channel_id` –≤–∏–¥–∞ `-100‚Ä¶` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ).
  * `price_min` / `price_max` ‚Äî –≤ –∑–≤—ë–∑–¥–∞—Ö.
  * `supply_min` / `supply_max` ‚Äî –æ–±—â–µ–µ –∏–∑–¥–∞–Ω–∏–µ (–µ—Å–ª–∏ `null`, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–µ—Ç).
* **Account**:

  * –ø—Ä–∏–≤—è–∑–∞–Ω –∫ API-–ø—Ä–æ—Ñ–∏–ª—é;
  * –≤ UI –≤–∏–¥–µ–Ω –±–∞–ª–∞–Ω—Å –∑–≤—ë–∑–¥; –±–∞–ª–∞–Ω—Å –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏.

---

## –û—Ç—á—ë—Ç—ã –∏ –ª–æ–≥–∏

* –í **–∫–æ–Ω—Å–æ–ª–∏**: –ø–æ–¥—Ä–æ–±–Ω–æ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –ø–ª–∞–Ω/–∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ, –ø—Ä–∏—á–∏–Ω—ã –æ—à–∏–±–æ–∫ –ø–æ –∫–∞–Ω–∞–ª–∞–º/–∞–∫–∫–∞—É–Ω—Ç–∞–º, –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø—Ä–æ–ø—É—Å–∫–∏.
* –í **–õ–° (–≤—Å–µ–º –≤–∞—à–∏–º –∞–∫–∫–∞—É–Ω—Ç–∞–º)**:

```
üßæ –û—Ç—á—ë—Ç –∞–≤—Ç–æ–ø–æ–∫—É–ø–∫–∏
üìä –ù–æ–≤—ã—Ö: 3 | –ö—É–ø–ª–µ–Ω–æ: 2 | –ü—Ä–æ–ø—É—â–µ–Ω–æ: 1

üì¶ –ü–æ –ø–æ–¥–∞—Ä–∫–∞–º:
‚Ä¢ ‚úÖ 123456 | 25‚≠ê | supply=1000 ‚Üí ch=-100111 acc=1337
‚Ä¢ ‚è≠Ô∏è 654321 | 50‚≠ê | supply=‚àû ‚Üí non-limited (skipped)
‚Ä¢ ‚ùå 222333 | 10‚≠ê | supply=500 ‚Üí –ø—Ä–∏—á–∏–Ω–∞ ch=-100222: insufficient_account_balance acc=1338 bal=5 need=10

üõ∞Ô∏è –ü–æ –∫–∞–Ω–∞–ª–∞–º:
‚Ä¢ -100111: plan=1 ok=1 fail=0 reasons=0
‚Ä¢ -100222: plan=1 ok=0 fail=0 reasons=1

üë§ –ü–æ –∞–∫–∫–∞—É–Ω—Ç–∞–º:
‚Ä¢ acc=1337: plan=1 üí∞spent=25 start=100 end=75 buys=1
‚Ä¢ acc=1338: plan=1 üí∞spent=0 start=5 end=5 buys=0
```

---

## –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

* **`send_gift_failed`**
  –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:

  * –∞–∫–∫–∞—É–Ω—Ç **—Å–æ—Å—Ç–æ–∏—Ç** –≤ –∫–∞–Ω–∞–ª–µ;
  * —É –±–æ—Ç–∞ –µ—Å—Ç—å –ø—Ä–∞–≤–æ –ø–∏—Å–∞—Ç—å (–¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π), –∏ **–∞–∫–∫–∞—É–Ω—Ç** –∏–º–µ–µ—Ç –ø—Ä–∞–≤–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å gift;
  * gift —É–∂–µ –Ω–µ –∑–∞–∫–æ–Ω—á–∏–ª—Å—è/–Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è;
  * gift **–Ω–µ —Ç—Ä–µ–±—É–µ—Ç Premium**, –µ—Å–ª–∏ —É –∞–∫–∫–∞—É–Ω—Ç–∞ –µ–≥–æ –Ω–µ—Ç;
  * –±–∞–ª–∞–Ω—Å –¥–æ—Å—Ç–∞—Ç–æ—á–µ–Ω.

* **–ù–µ—Ç –ø–æ–∫—É–ø–æ–∫, ¬´no\_channel\_match¬ª**
  –ü–æ–¥–∞—Ä–æ–∫ –Ω–µ –ø–æ–ø–∞–ª –≤ —Ä–∞–º–∫–∏ –Ω–∏ –æ–¥–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `price_min/max` –∏ `supply_min/max`.

* **–ù–∏—á–µ–≥–æ –Ω–µ –≤–∏–¥–Ω–æ –≤ ¬´–ü–æ–¥–∞—Ä–∫–∞—Ö¬ª**
  –ù–∞–∂–º–∏—Ç–µ —Ä—É—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–ª–∏ –¥–æ–∂–¥–∏—Ç–µ—Å—å –≤–æ—Ä–∫–µ—Ä–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ (–¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ .tgs).

* **Windows –ø—Ä–æ–¥–∞–∫—à–µ–Ω**
  Gunicorn –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `waitress-serve` –∏–ª–∏ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–π—Ç–µ –Ω–∞ Linux-—Å–µ—Ä–≤–µ—Ä–µ.


## –õ–∏—Ü–µ–Ω–∑–∏—è

Apache-2.0 ¬© 2025 Vova Orig. –°–º. LICENSE –∏ NOTICE.

---
